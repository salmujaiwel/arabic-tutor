// Parse Gemini API response AND build final webhook response
const previousData = $('Code').all()[0].json; // Get data from first Code node
const geminiResponse = $json; // Get HTTP response from Gemini

console.log('ğŸ” Building final response...');
console.log('ğŸ” Previous data keys:', Object.keys(previousData));

try {
  // Parse Gemini response
  if (!geminiResponse.candidates || !geminiResponse.candidates[0] || !geminiResponse.candidates[0].content) {
    throw new Error('Invalid Gemini response structure');
  }
  
  const feedback = geminiResponse.candidates[0].content.parts[0].text;
  console.log('ğŸ” Generated feedback length:', feedback.length);
  
  // Extract rating with multiple pattern matching
  let rating = 5;
  const ratingPatterns = [
    /\*\*Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:\*\*\s*(\d+(?:\.\d+)?)\s*\/\s*10/,
    /Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:\s*(\d+(?:\.\d+)?)\s*\/\s*10/,
    /(\d+(?:\.\d+)?)\s*\/\s*10/
  ];
  
  for (const pattern of ratingPatterns) {
    const match = feedback.match(pattern);
    if (match) {
      rating = parseFloat(match[1]);
      console.log('ğŸ” Found rating:', rating);
      break;
    }
  }
  
  // Extract summary with multiple pattern matching
  let summary = 'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ù‚Ø§Ù„ ÙˆØªÙ‚ÙŠÙŠÙ…Ù‡ Ø¨Ù†Ø¬Ø§Ø­';
  const summaryPatterns = [
    /\*\*Ø§Ù„Ù…Ù„Ø®Øµ:\*\*\s*(.+?)(?:\n\n|\*\*|$)/s,
    /Ø§Ù„Ù…Ù„Ø®Øµ:\s*(.+?)(?:\n\n|\*\*|$)/s,
    /\*\*Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:\*\*\s*(.+?)(?:\n\n|\*\*|$)/s
  ];
  
  for (const pattern of summaryPatterns) {
    const match = feedback.match(pattern);
    if (match) {
      summary = match[1].trim();
      console.log('ğŸ” Found summary:', summary.substring(0, 100) + '...');
      break;
    }
  }
  
  // If no summary found, extract first meaningful sentence
  if (summary === 'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ù‚Ø§Ù„ ÙˆØªÙ‚ÙŠÙŠÙ…Ù‡ Ø¨Ù†Ø¬Ø§Ø­') {
    const lines = feedback.split('\n').filter(line => 
      line.trim().length > 15 && 
      !line.includes('**Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:**') &&
      !line.includes('Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:') &&
      !line.includes('ØªØ­Ø°ÙŠØ±Ø§Øª') &&
      !line.includes('Ø§Ù„Ù…Ø·Ù„ÙˆØ¨')
    );
    if (lines.length > 0) {
      summary = lines[0].replace(/^\*\*.*?\*\*\s*/, '').trim();
    }
  }
  
  // Clean up formatting by removing ** markers
  const cleanedFeedback = feedback.replace(/\*\*/g, '');
  const cleanedSummary = summary.replace(/\*\*/g, '');
  
  // Build the EXACT response the HTML form expects with new fields
  const finalResponse = {
    // Original fields
    student_id: previousData.student_id,
    weekly_topic: previousData.weekly_topic,
    article: previousData.article,
    type_token_ratio: previousData.type_token_ratio,
    lexical_diversity: previousData.lexical_diversity,
    lexical_density: previousData.lexical_density,
    gemini_rating: rating,
    feedback_summary: cleanedSummary,
    gemini_feedback: cleanedFeedback,
    created_at: previousData.created_at,
    
    // New fields for title and structure
    title: previousData.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†',
    paragraph_count: previousData.paragraph_count || 0,
    structure_valid: previousData.structure_valid || false,
    structure_note: previousData.structure_note || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
    
    // Additional metadata
    word_count: previousData.word_count || 0,
    skill_focus: previousData.skill_focus || previousData.weekly_topic,
    evaluation_ready: true
  };
  
  console.log('ğŸ” Final response built successfully');
  console.log('ğŸ” Response includes title:', !!finalResponse.title);
  console.log('ğŸ” Response includes structure info:', !!finalResponse.structure_note);
  
  return finalResponse;
  
} catch (error) {
  console.error('ğŸ” Parsing error:', error);
  console.error('ğŸ” Error stack:', error.stack);
  
  // Return enhanced error response with all fields
  return {
    // Original fields
    student_id: previousData.student_id,
    weekly_topic: previousData.weekly_topic,
    article: previousData.article,
    type_token_ratio: previousData.type_token_ratio || 0,
    lexical_diversity: previousData.lexical_diversity || 0,
    lexical_density: previousData.lexical_density || 0,
    gemini_rating: 5,
    feedback_summary: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…',
    gemini_feedback: `ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù‚Ø§Ù„Ùƒ "${previousData.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}" Ø­ÙˆÙ„ "${previousData.weekly_topic}" ÙˆÙ„ÙƒÙ† Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.`,
    created_at: previousData.created_at,
    
    // New fields with defaults
    title: previousData.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†',
    paragraph_count: previousData.paragraph_count || 0,
    structure_valid: false,
    structure_note: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù‡ÙŠÙƒÙ„',
    word_count: previousData.word_count || 0,
    skill_focus: previousData.skill_focus || previousData.weekly_topic,
    evaluation_ready: false,
    error_occurred: true,
    error_message: error.message
  };
}
