// Parse Gemini API response AND build final webhook response
const previousData = $('Code').all()[0].json; // Get data from first Code node
const geminiResponse = $json; // Get HTTP response from Gemini

console.log('🔍 Building final response...');
console.log('🔍 Previous data keys:', Object.keys(previousData));

try {
  // Parse Gemini response
  if (!geminiResponse.candidates || !geminiResponse.candidates[0] || !geminiResponse.candidates[0].content) {
    throw new Error('Invalid Gemini response structure');
  }
  
  const feedback = geminiResponse.candidates[0].content.parts[0].text;
  console.log('🔍 Generated feedback length:', feedback.length);
  
  // Extract rating with multiple pattern matching
  let rating = 5;
  const ratingPatterns = [
    /\*\*التقييم:\*\*\s*(\d+(?:\.\d+)?)\s*\/\s*10/,
    /التقييم:\s*(\d+(?:\.\d+)?)\s*\/\s*10/,
    /(\d+(?:\.\d+)?)\s*\/\s*10/
  ];
  
  for (const pattern of ratingPatterns) {
    const match = feedback.match(pattern);
    if (match) {
      rating = parseFloat(match[1]);
      console.log('🔍 Found rating:', rating);
      break;
    }
  }
  
  // Extract summary with multiple pattern matching
  let summary = 'تم استلام المقال وتقييمه بنجاح';
  const summaryPatterns = [
    /\*\*الملخص:\*\*\s*(.+?)(?:\n\n|\*\*|$)/s,
    /الملخص:\s*(.+?)(?:\n\n|\*\*|$)/s,
    /\*\*ملخص التقييم:\*\*\s*(.+?)(?:\n\n|\*\*|$)/s
  ];
  
  for (const pattern of summaryPatterns) {
    const match = feedback.match(pattern);
    if (match) {
      summary = match[1].trim();
      console.log('🔍 Found summary:', summary.substring(0, 100) + '...');
      break;
    }
  }
  
  // If no summary found, extract first meaningful sentence
  if (summary === 'تم استلام المقال وتقييمه بنجاح') {
    const lines = feedback.split('\n').filter(line => 
      line.trim().length > 15 && 
      !line.includes('**التقييم:**') &&
      !line.includes('التقييم:') &&
      !line.includes('تحذيرات') &&
      !line.includes('المطلوب')
    );
    if (lines.length > 0) {
      summary = lines[0].replace(/^\*\*.*?\*\*\s*/, '').trim();
    }
  }
  
  // Clean up formatting by removing ** markers
  const cleanedFeedback = feedback.replace(/\*\*/g, '');
  const cleanedSummary = summary.replace(/\*\*/g, '');
  
  // Build the EXACT response the HTML form expects with new fields
  const finalResponse = {
    // Original fields
    student_id: previousData.student_id,
    weekly_topic: previousData.weekly_topic,
    article: previousData.article,
    type_token_ratio: previousData.type_token_ratio,
    lexical_diversity: previousData.lexical_diversity,
    lexical_density: previousData.lexical_density,
    gemini_rating: rating,
    feedback_summary: cleanedSummary,
    gemini_feedback: cleanedFeedback,
    created_at: previousData.created_at,
    
    // New fields for title and structure
    title: previousData.title || 'بدون عنوان',
    paragraph_count: previousData.paragraph_count || 0,
    structure_valid: previousData.structure_valid || false,
    structure_note: previousData.structure_note || 'غير محدد',
    
    // Additional metadata
    word_count: previousData.word_count || 0,
    skill_focus: previousData.skill_focus || previousData.weekly_topic,
    evaluation_ready: true
  };
  
  console.log('🔍 Final response built successfully');
  console.log('🔍 Response includes title:', !!finalResponse.title);
  console.log('🔍 Response includes structure info:', !!finalResponse.structure_note);
  
  return finalResponse;
  
} catch (error) {
  console.error('🔍 Parsing error:', error);
  console.error('🔍 Error stack:', error.stack);
  
  // Return enhanced error response with all fields
  return {
    // Original fields
    student_id: previousData.student_id,
    weekly_topic: previousData.weekly_topic,
    article: previousData.article,
    type_token_ratio: previousData.type_token_ratio || 0,
    lexical_diversity: previousData.lexical_diversity || 0,
    lexical_density: previousData.lexical_density || 0,
    gemini_rating: 5,
    feedback_summary: 'حدث خطأ في معالجة التقييم',
    gemini_feedback: `تم استلام مقالك "${previousData.title || 'بدون عنوان'}" حول "${previousData.weekly_topic}" ولكن حدث خطأ في المعالجة. يرجى المحاولة مرة أخرى.`,
    created_at: previousData.created_at,
    
    // New fields with defaults
    title: previousData.title || 'بدون عنوان',
    paragraph_count: previousData.paragraph_count || 0,
    structure_valid: false,
    structure_note: 'حدث خطأ في تحليل الهيكل',
    word_count: previousData.word_count || 0,
    skill_focus: previousData.skill_focus || previousData.weekly_topic,
    evaluation_ready: false,
    error_occurred: true,
    error_message: error.message
  };
}
